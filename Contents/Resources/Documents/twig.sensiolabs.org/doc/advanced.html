<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="robots" content="index, follow, all" />
    <meta name="Author" content="Sensio Labs" />
    <meta name="Language" content="en" />
    <meta name="Copyright" content="Sensio" />
    <meta name="Publisher" content="Sensio" />
    <meta name="Description" content="Twig - The flexible, fast, and secure template engine for PHP" />
    <meta name="Keywords" content="twig, templating, template, engine, template engine, template language, php" />

    <title>Extending Twig - Documentation - Twig - The flexible, fast, and secure PHP template engine</title>

    <link href="../css/reset-min.css" rel="stylesheet" type="text/css" />
    <link href="../css/base.css" rel="stylesheet" type="text/css" />
    <link href="../css/colors.css" rel="stylesheet" type="text/css" />
    <link href="../css/code.css" rel="stylesheet" type="text/css" />
    <link href="../css/pygments.css" rel="stylesheet" type="text/css" />

    
    <link rel="alternate" type="application/rss+xml" href="http://feeds.feedburner.com/twig-project" />

    <link href="http://connect.sensiolabs.com/css/sln.css" rel="stylesheet" type="text/css" media="all" />

    <script type="text/javascript" src="../js/jquery-1.7.2.min.js"></script>

    <script type="text/javascript">
        (function(w, d, s) {
            function go() {
                var js, fjs = d.getElementsByTagName(s)[0], load = function(url, id) {
                    if (d.getElementById(id)) {return;}
                    js = d.createElement(s); js.src = url; js.id = id;
                    fjs.parentNode.insertBefore(js, fjs);
                };
                load('https://connect.sensiolabs.com/sln.js?customize_url=/js/sln_customize.js', 'sln_bar');
            }
            if (w.addEventListener) { w.addEventListener("load", go, false); }
            else if (w.attachEvent) { w.attachEvent("onload",go); }
        } (window, document, 'script'));
    </script>

    <!--[if IE 6]>
      <script type="text/javascript" src="/js/DD_belatedPNG_0.0.7a-min.js"></script>
      <script type="text/javascript">
        DD_belatedPNG.fix('.png_fix');
      </script>
    <![endif]-->

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-10931939-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script');
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        ga.setAttribute('async', 'true');
        document.documentElement.firstChild.appendChild(ga);
      })();
    </script>
  </head>
  <body>
    <div id="sln"></div>
    <div class="hd">
      <div class="illustration png_fix">
        <div class="content">
          <div class="sensio_product">
            <img class="png_fix" src="../images/sensio-labs-product.png" alt="a Sensio Labs Product" />
          </div>
          <div class="clearfix">
            <div class="logo_header"><a href="../index.html">TWIG</a></div>
            <h1 class="title_header">
              The flexible, fast, and secure<br />template engine for PHP
            </h1>
          </div>

          <div class="menu">
            <ul>
              <li><a href="../index.html">ABOUT</a></li>
              <li><a class="active" href="../documentation">DOCUMENTATION</a></li>
              <li><a href="http://blog.twig.sensiolabs.org/">BLOG</a></li>
              <li><a href="../development">DEVELOPMENT</a></li>
              <li><a href="../contributors">CONTRIBUTORS</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="bd">
      <div class="content">
                        <div class="infobar clearfix">
                    <div id="doc-toc" class="infobar-box">
            <h3>Table of Contents</h3>
            <ul>
<li><a class="reference internal" href="advanced.html#">Extending Twig</a><ul>
<li><a class="reference internal" href="advanced.html#globals">Globals</a></li>
<li><a class="reference internal" href="advanced.html#filters">Filters</a><ul>
<li><a class="reference internal" href="advanced.html#environment-aware-filters">Environment aware Filters</a></li>
<li><a class="reference internal" href="advanced.html#automatic-escaping">Automatic Escaping</a></li>
<li><a class="reference internal" href="advanced.html#dynamic-filters">Dynamic Filters</a></li>
</ul>
</li>
<li><a class="reference internal" href="advanced.html#functions">Functions</a><ul>
<li><a class="reference internal" href="advanced.html#dynamic-functions">Dynamic Functions</a></li>
</ul>
</li>
<li><a class="reference internal" href="advanced.html#tags">Tags</a><ul>
<li><a class="reference internal" href="advanced.html#registering-a-new-tag">Registering a new tag</a></li>
<li><a class="reference internal" href="advanced.html#defining-a-token-parser">Defining a Token Parser</a></li>
<li><a class="reference internal" href="advanced.html#defining-a-node">Defining a Node</a></li>
</ul>
</li>
<li><a class="reference internal" href="advanced.html#creating-an-extension">Creating an Extension</a><ul>
<li><a class="reference internal" href="advanced.html#id1">Globals</a></li>
<li><a class="reference internal" href="advanced.html#id2">Functions</a></li>
<li><a class="reference internal" href="advanced.html#id3">Filters</a><ul>
<li><a class="reference internal" href="advanced.html#overriding-default-filters">Overriding default Filters</a></li>
</ul>
</li>
<li><a class="reference internal" href="advanced.html#id4">Tags</a></li>
<li><a class="reference internal" href="advanced.html#operators">Operators</a></li>
<li><a class="reference internal" href="advanced.html#tests">Tests</a></li>
</ul>
</li>
<li><a class="reference internal" href="advanced.html#testing-an-extension">Testing an Extension</a><ul>
<li><a class="reference internal" href="advanced.html#functional-tests">Functional Tests</a></li>
<li><a class="reference internal" href="advanced.html#node-tests">Node Tests</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            </div>
        
        <div class="infobar-box">
            <h3>Questions &amp; Feedback</h3>
            <div class="feedback">
                <p>
                  <strong>Found a typo or an error?</strong><br />
                  Want to improve this document? <a href="https://github.com/fabpot/Twig/edit/master/doc/advanced.rst">Edit</a> it.
                </p>
                <p>
                  <strong>Need support or have a technical question?</strong><br />
                  Post to the <a href="http://groups.google.com/group/twig-users">user mailing-list</a>.
                 </p>
            </div>

            <h3>License</h3>
            <div id="license">
                <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/"><img alt="Creative Commons License" src="http://symfony.com/images/license.png" /></a>
                Twig <span xmlns:dc="http://purl.org/dc/elements/1.1/" href="http://purl.org/dc/dcmitype/MovingImage" rel="dc:type">documentation</span> is licensed under a
                Creative Commons Attribution-Share Alike 3.0
                Unported <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">License</a>.
            </div>
        </div>
    </div>

    <div class="body-web">
        <div class="section" id="extending-twig">
<h1>Extending Twig<a class="headerlink" href="advanced.html#extending-twig" title="Permalink to this headline">¶</a></h1>
<p>Twig can be extended in many ways; you can add extra tags, filters, tests,
operators, global variables, and functions. You can even extend the parser
itself with node visitors.</p>
<div class="admonition-wrapper">
<div class="note"></div><div class="admonition admonition-note"><p class="first admonition-title">Note</p>
<p class="last">The first section of this chapter describes how to extend Twig easily. If
you want to reuse your changes in different projects or if you want to
share them with others, you should then create an extension as described
in the following section.</p>
</div></div>
<div class="admonition-wrapper">
<div class="caution"></div><div class="admonition admonition-caution"><p class="first admonition-title">Caution</p>
<p class="last">When extending Twig by calling methods on the Twig environment instance,
Twig won't be able to recompile your templates when the PHP code is
updated. To see your changes in real-time, either disable template caching
or package your code into an extension (see the next section of this
chapter).</p>
</div></div>
<p>Before extending Twig, you must understand the differences between all the
different possible extension points and when to use them.</p>
<p>First, remember that Twig has two main language constructs:</p>
<ul class="simple">
<li><tt class="docutils literal"><code>{{ }}</code></tt>: used to print the result of an expression evaluation;</li>
<li><tt class="docutils literal"><code>{% %}</code></tt>: used to execute statements.</li>
</ul>
<p>To understand why Twig exposes so many extension points, let's see how to
implement a <em>Lorem ipsum</em> generator (it needs to know the number of words to
generate).</p>
<p>You can use a <tt class="docutils literal"><code>lipsum</code></tt> <em>tag</em>:</p>
<div class="literal-block"><div class="highlight-jinja"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">{%</span> <span class="k">lipsum</span> <span class="m">40</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</td></tr></table></div></div>
<p>That works, but using a tag for <tt class="docutils literal"><code>lipsum</code></tt> is not a good idea for at least
three main reasons:</p>
<ul>
<li><p class="first"><tt class="docutils literal"><code>lipsum</code></tt> is not a language construct;</p>
</li>
<li><p class="first">The tag outputs something;</p>
</li>
<li><p class="first">The tag is not flexible as you cannot use it in an expression:</p>
<div class="literal-block"><div class="highlight-jinja"><pre>{{ 'some text' ~ {% lipsum 40 %} ~ 'some more text' }}</pre>
</div></div>
</li>
</ul>
<p>In fact, you rarely need to create tags; and that's good news because tags are
the most complex extension point of Twig.</p>
<p>Now, let's use a <tt class="docutils literal"><code>lipsum</code></tt> <em>filter</em>:</p>
<div class="literal-block"><div class="highlight-jinja"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">{{</span> <span class="m">40</span><span class="o">|</span><span class="nf">lipsum</span> <span class="cp">}}</span><span class="x"></span>
</pre></div>
</td></tr></table></div></div>
<p>Again, it works, but it looks weird. A filter transforms the passed value to
something else but here we use the value to indicate the number of words to
generate (so, <tt class="docutils literal"><code>40</code></tt> is an argument of the filter, not the value we want to
transform).</p>
<p>Next, let's use a <tt class="docutils literal"><code>lipsum</code></tt> <em>function</em>:</p>
<div class="literal-block"><div class="highlight-jinja"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">{{</span> <span class="nv">lipsum</span><span class="o">(</span><span class="m">40</span><span class="o">)</span> <span class="cp">}}</span><span class="x"></span>
</pre></div>
</td></tr></table></div></div>
<p>Here we go. For this specific example, the creation of a function is the
extension point to use. And you can use it anywhere an expression is accepted:</p>
<div class="literal-block"><div class="highlight-jinja"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">{{</span> <span class="s1">&#39;some text&#39;</span> <span class="o">~</span> <span class="nv">ipsum</span><span class="o">(</span><span class="m">40</span><span class="o">)</span> <span class="o">~</span> <span class="s1">&#39;some more text&#39;</span> <span class="cp">}}</span><span class="x"></span>

<span class="cp">{%</span> <span class="k">set</span> <span class="nv">ipsum</span> <span class="o">=</span> <span class="nv">ipsum</span><span class="o">(</span><span class="m">40</span><span class="o">)</span> <span class="cp">%}</span><span class="x"></span>
</pre></div>
</td></tr></table></div></div>
<p>Last but not the least, you can also use a <em>global</em> object with a method able
to generate lorem ipsum text:</p>
<div class="literal-block"><div class="highlight-jinja"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">{{</span> <span class="nv">text.lipsum</span><span class="o">(</span><span class="m">40</span><span class="o">)</span> <span class="cp">}}</span><span class="x"></span>
</pre></div>
</td></tr></table></div></div>
<p>As a rule of thumb, use functions for frequently used features and global
objects for everything else.</p>
<p>Keep in mind the following when you want to extend Twig:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="37%" />
<col width="14%" />
<col width="35%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">What?</th>
<th class="head">Implementation difficulty?</th>
<th class="head">How often?</th>
<th class="head">When?</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><em>macro</em></td>
<td>trivial</td>
<td>frequent</td>
<td>Content generation</td>
</tr>
<tr class="row-odd"><td><em>global</em></td>
<td>trivial</td>
<td>frequent</td>
<td>Helper object</td>
</tr>
<tr class="row-even"><td><em>function</em></td>
<td>trivial</td>
<td>frequent</td>
<td>Content generation</td>
</tr>
<tr class="row-odd"><td><em>filter</em></td>
<td>trivial</td>
<td>frequent</td>
<td>Value transformation</td>
</tr>
<tr class="row-even"><td><em>tag</em></td>
<td>complex</td>
<td>rare</td>
<td>DSL language construct</td>
</tr>
<tr class="row-odd"><td><em>test</em></td>
<td>trivial</td>
<td>rare</td>
<td>Boolean decision</td>
</tr>
<tr class="row-even"><td><em>operator</em></td>
<td>trivial</td>
<td>rare</td>
<td>Values transformation</td>
</tr>
</tbody>
</table>
<div class="section" id="globals">
<h2>Globals<a class="headerlink" href="advanced.html#globals" title="Permalink to this headline">¶</a></h2>
<p>A global variable is like any other template variable, except that it's
available in all templates and macros:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="nv">$twig</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Twig_Environment</span><span class="p">(</span><span class="nv">$loader</span><span class="p">);</span>
<span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">addGlobal</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Text</span><span class="p">());</span>
</pre></div>
</td></tr></table></div></div>
<p>You can then use the <tt class="docutils literal"><code>text</code></tt> variable anywhere in a template:</p>
<div class="literal-block"><div class="highlight-jinja"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">{{</span> <span class="nv">text.lipsum</span><span class="o">(</span><span class="m">40</span><span class="o">)</span> <span class="cp">}}</span><span class="x"></span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="section" id="filters">
<h2>Filters<a class="headerlink" href="advanced.html#filters" title="Permalink to this headline">¶</a></h2>
<p>A filter is a regular PHP function or an object method that takes the left
side of the filter (before the pipe <tt class="docutils literal"><code>|</code></tt>) as first argument and the extra
arguments passed to the filter (within parentheses <tt class="docutils literal"><code>()</code></tt>) as extra arguments.</p>
<p>Defining a filter is as easy as associating the filter name with a PHP
callable. For instance, let's say you have the following code in a template:</p>
<div class="literal-block"><div class="highlight-jinja"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">{{</span> <span class="s1">&#39;TWIG&#39;</span><span class="o">|</span><span class="nf">lower</span> <span class="cp">}}</span><span class="x"></span>
</pre></div>
</td></tr></table></div></div>
<p>When compiling this template to PHP, Twig looks for the PHP callable
associated with the <tt class="docutils literal"><code>lower</code></tt> filter. The <tt class="docutils literal"><code>lower</code></tt> filter is a built-in Twig
filter, and it is simply mapped to the PHP <tt class="docutils literal"><code>strtolower()</code></tt> function. After
compilation, the generated PHP code is roughly equivalent to:</p>
<div class="literal-block"><div class="highlight-html+php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">strtolower</span><span class="p">(</span><span class="s1">&#39;TWIG&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span>
</pre></div>
</td></tr></table></div></div>
<p>As you can see, the <tt class="docutils literal"><code>'TWIG'</code></tt> string is passed as a first argument to the PHP
function.</p>
<p>A filter can also take extra arguments like in the following example:</p>
<div class="literal-block"><div class="highlight-jinja"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">{{</span> <span class="nv">now</span><span class="o">|</span><span class="nf">date</span><span class="o">(</span><span class="s1">&#39;d/m/Y&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="x"></span>
</pre></div>
</td></tr></table></div></div>
<p>In this case, the extra arguments are passed to the function after the main
argument, and the compiled code is equivalent to:</p>
<div class="literal-block"><div class="highlight-html+php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nx">twig_date_format_filter</span><span class="p">(</span><span class="nv">$now</span><span class="p">,</span> <span class="s1">&#39;d/m/Y&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span>
</pre></div>
</td></tr></table></div></div>
<p>Let's see how to create a new filter.</p>
<p>In this section, we will create a <tt class="docutils literal"><code>rot13</code></tt> filter, which should return the
<a class="reference external" href="http://www.php.net/manual/en/function.str-rot13.php">rot13</a> transformation of a string. Here is an example of its usage and the
expected output:</p>
<div class="literal-block"><div class="highlight-jinja"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">{{</span> <span class="s2">&quot;Twig&quot;</span><span class="o">|</span><span class="nf">rot13</span> <span class="cp">}}</span><span class="x"></span>

<span class="c">{# should displays Gjvt #}</span><span class="x"></span>
</pre></div>
</td></tr></table></div></div>
<p>Adding a filter is as simple as calling the <tt class="docutils literal"><code>addFilter()</code></tt> method on the
<tt class="docutils literal"><code>Twig_Environment</code></tt> instance:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="nv">$twig</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Twig_Environment</span><span class="p">(</span><span class="nv">$loader</span><span class="p">);</span>
<span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">addFilter</span><span class="p">(</span><span class="s1">&#39;rot13&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Twig_Filter_Function</span><span class="p">(</span><span class="s1">&#39;str_rot13&#39;</span><span class="p">));</span>
</pre></div>
</td></tr></table></div></div>
<p>The second argument of <tt class="docutils literal"><code>addFilter()</code></tt> is an instance of <tt class="docutils literal"><code>Twig_Filter</code></tt>.
Here, we use <tt class="docutils literal"><code>Twig_Filter_Function</code></tt> as the filter is a PHP function. The
first argument passed to the <tt class="docutils literal"><code>Twig_Filter_Function</code></tt> constructor is the name
of the PHP function to call, here <tt class="docutils literal"><code>str_rot13</code></tt>, a native PHP function.</p>
<p>Let's say I now want to be able to add a prefix before the converted string:</p>
<div class="literal-block"><div class="highlight-jinja"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">{{</span> <span class="s2">&quot;Twig&quot;</span><span class="o">|</span><span class="nf">rot13</span><span class="o">(</span><span class="s1">&#39;prefix_&#39;</span><span class="o">)</span> <span class="cp">}}</span><span class="x"></span>

<span class="c">{# should displays prefix_Gjvt #}</span><span class="x"></span>
</pre></div>
</td></tr></table></div></div>
<p>As the PHP <tt class="docutils literal"><code>str_rot13()</code></tt> function does not support this requirement, let's
create a new PHP function:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">function</span> <span class="nf">project_compute_rot13</span><span class="p">(</span><span class="nv">$string</span><span class="p">,</span> <span class="nv">$prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nv">$prefix</span><span class="o">.</span><span class="nb">str_rot13</span><span class="p">(</span><span class="nv">$string</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>As you can see, the <tt class="docutils literal"><code>prefix</code></tt> argument of the filter is passed as an extra
argument to the <tt class="docutils literal"><code>project_compute_rot13()</code></tt> function.</p>
<p>Adding this filter is as easy as before:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">addFilter</span><span class="p">(</span><span class="s1">&#39;rot13&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Twig_Filter_Function</span><span class="p">(</span><span class="s1">&#39;project_compute_rot13&#39;</span><span class="p">));</span>
</pre></div>
</td></tr></table></div></div>
<p>For better encapsulation, a filter can also be defined as a static method of a
class. The <tt class="docutils literal"><code>Twig_Filter_Function</code></tt> class can also be used to register such
static methods as filters:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">addFilter</span><span class="p">(</span><span class="s1">&#39;rot13&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Twig_Filter_Function</span><span class="p">(</span><span class="s1">&#39;SomeClass::rot13Filter&#39;</span><span class="p">));</span>
</pre></div>
</td></tr></table></div></div>
<div class="admonition-wrapper">
<div class="tip"></div><div class="admonition admonition-tip"><p class="first admonition-title">Tip</p>
<p class="last">In an extension, you can also define a filter as a static method of the
extension class.</p>
</div></div>
<div class="section" id="environment-aware-filters">
<h3>Environment aware Filters<a class="headerlink" href="advanced.html#environment-aware-filters" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><code>Twig_Filter</code></tt> classes take options as their last argument. For instance,
if you want access to the current environment instance in your filter, set the
<tt class="docutils literal"><code>needs_environment</code></tt> option to <tt class="docutils literal"><code>true</code></tt>:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="nv">$filter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Twig_Filter_Function</span><span class="p">(</span><span class="s1">&#39;str_rot13&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;needs_environment&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">));</span>
</pre></div>
</td></tr></table></div></div>
<p>Twig will then pass the current environment as the first argument to the
filter call:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">function</span> <span class="nf">twig_compute_rot13</span><span class="p">(</span><span class="nx">Twig_Environment</span> <span class="nv">$env</span><span class="p">,</span> <span class="nv">$string</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// get the current charset for instance</span>
    <span class="nv">$charset</span> <span class="o">=</span> <span class="nv">$env</span><span class="o">-&gt;</span><span class="na">getCharset</span><span class="p">();</span>

    <span class="k">return</span> <span class="nb">str_rot13</span><span class="p">(</span><span class="nv">$string</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="section" id="automatic-escaping">
<h3>Automatic Escaping<a class="headerlink" href="advanced.html#automatic-escaping" title="Permalink to this headline">¶</a></h3>
<p>If automatic escaping is enabled, the output of the filter may be escaped
before printing. If your filter acts as an escaper (or explicitly outputs html
or javascript code), you will want the raw output to be printed. In such a
case, set the <tt class="docutils literal"><code>is_safe</code></tt> option:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="nv">$filter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Twig_Filter_Function</span><span class="p">(</span><span class="s1">&#39;nl2br&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;is_safe&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;html&#39;</span><span class="p">)));</span>
</pre></div>
</td></tr></table></div></div>
<p>Some filters may need to work on input that is already escaped or safe, for
example when adding (safe) html tags to originally unsafe output. In such a
case, set the <tt class="docutils literal"><code>pre_escape</code></tt> option to escape the input data before it is run
through your filter:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="nv">$filter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Twig_Filter_Function</span><span class="p">(</span><span class="s1">&#39;somefilter&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;pre_escape&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="s1">&#39;is_safe&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;html&#39;</span><span class="p">)));</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="section" id="dynamic-filters">
<h3>Dynamic Filters<a class="headerlink" href="advanced.html#dynamic-filters" title="Permalink to this headline">¶</a></h3>
<p class="versionadded">
<span class="versionmodified">New in version 1.5: </span>Dynamic filters support was added in Twig 1.5.</p>
<p>A filter name containing the special <tt class="docutils literal"><code>*</code></tt> character is a dynamic filter as
the <tt class="docutils literal"><code>*</code></tt> can be any string:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">addFilter</span><span class="p">(</span><span class="s1">&#39;*_path&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Twig_Filter_Function</span><span class="p">(</span><span class="s1">&#39;twig_path&#39;</span><span class="p">));</span>

<span class="k">function</span> <span class="nf">twig_path</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$arguments</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>The following filters will be matched by the above defined dynamic filter:</p>
<ul class="simple">
<li><tt class="docutils literal"><code>product_path</code></tt></li>
<li><tt class="docutils literal"><code>category_path</code></tt></li>
</ul>
<p>A dynamic filter can define more than one dynamic parts:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">addFilter</span><span class="p">(</span><span class="s1">&#39;*_path_*&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Twig_Filter_Function</span><span class="p">(</span><span class="s1">&#39;twig_path&#39;</span><span class="p">));</span>

<span class="k">function</span> <span class="nf">twig_path</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$suffix</span><span class="p">,</span> <span class="nv">$arguments</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>The filter will receive all dynamic part values before the normal filters
arguments. For instance, a call to <tt class="docutils literal"><code>'foo'|a_path_b()</code></tt> will result in the
following PHP call: <tt class="docutils literal"><code>twig_path('a', 'b', 'foo')</code></tt>.</p>
</div>
</div>
<div class="section" id="functions">
<h2>Functions<a class="headerlink" href="advanced.html#functions" title="Permalink to this headline">¶</a></h2>
<p>A function is a regular PHP function or an object method that can be called from
templates.</p>
<div class="literal-block"><div class="highlight-jinja"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">{{</span> <span class="nv">constant</span><span class="o">(</span><span class="s2">&quot;DATE_W3C&quot;</span><span class="o">)</span> <span class="cp">}}</span><span class="x"></span>
</pre></div>
</td></tr></table></div></div>
<p>When compiling this template to PHP, Twig looks for the PHP callable
associated with the <tt class="docutils literal"><code>constant</code></tt> function. The <tt class="docutils literal"><code>constant</code></tt> function is a built-in Twig
function, and it is simply mapped to the PHP <tt class="docutils literal"><code>constant()</code></tt> function. After
compilation, the generated PHP code is roughly equivalent to:</p>
<div class="literal-block"><div class="highlight-html+php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">&lt;?php</span> <span class="k">echo</span> <span class="nb">constant</span><span class="p">(</span><span class="s1">&#39;DATE_W3C&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span>
</pre></div>
</td></tr></table></div></div>
<p>Adding a function is similar to adding a filter. This can be done by calling the
<tt class="docutils literal"><code>addFunction()</code></tt> method on the <tt class="docutils literal"><code>Twig_Environment</code></tt> instance:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="nv">$twig</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Twig_Environment</span><span class="p">(</span><span class="nv">$loader</span><span class="p">);</span>
<span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">addFunction</span><span class="p">(</span><span class="s1">&#39;functionName&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Twig_Function_Function</span><span class="p">(</span><span class="s1">&#39;someFunction&#39;</span><span class="p">));</span>
</pre></div>
</td></tr></table></div></div>
<p>You can also expose extension methods as functions in your templates:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span class="c1">// $this is an object that implements Twig_ExtensionInterface.</span>
<span class="nv">$twig</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Twig_Environment</span><span class="p">(</span><span class="nv">$loader</span><span class="p">);</span>
<span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">addFunction</span><span class="p">(</span><span class="s1">&#39;otherFunction&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Twig_Function_Method</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;someMethod&#39;</span><span class="p">));</span>
</pre></div>
</td></tr></table></div></div>
<p>Functions also support <tt class="docutils literal"><code>needs_environment</code></tt> and <tt class="docutils literal"><code>is_safe</code></tt> parameters.</p>
<div class="section" id="dynamic-functions">
<h3>Dynamic Functions<a class="headerlink" href="advanced.html#dynamic-functions" title="Permalink to this headline">¶</a></h3>
<p class="versionadded">
<span class="versionmodified">New in version 1.5: </span>Dynamic functions support was added in Twig 1.5.</p>
<p>A function name containing the special <tt class="docutils literal"><code>*</code></tt> character is a dynamic function
as the <tt class="docutils literal"><code>*</code></tt> can be any string:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">addFunction</span><span class="p">(</span><span class="s1">&#39;*_path&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Twig_Function_Function</span><span class="p">(</span><span class="s1">&#39;twig_path&#39;</span><span class="p">));</span>

<span class="k">function</span> <span class="nf">twig_path</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$arguments</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>The following functions will be matched by the above defined dynamic function:</p>
<ul class="simple">
<li><tt class="docutils literal"><code>product_path</code></tt></li>
<li><tt class="docutils literal"><code>category_path</code></tt></li>
</ul>
<p>A dynamic function can define more than one dynamic parts:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">addFilter</span><span class="p">(</span><span class="s1">&#39;*_path_*&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Twig_Filter_Function</span><span class="p">(</span><span class="s1">&#39;twig_path&#39;</span><span class="p">));</span>

<span class="k">function</span> <span class="nf">twig_path</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$suffix</span><span class="p">,</span> <span class="nv">$arguments</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>The function will receive all dynamic part values before the normal functions
arguments. For instance, a call to <tt class="docutils literal"><code>a_path_b('foo')</code></tt> will result in the
following PHP call: <tt class="docutils literal"><code>twig_path('a', 'b', 'foo')</code></tt>.</p>
</div>
</div>
<div class="section" id="tags">
<h2>Tags<a class="headerlink" href="advanced.html#tags" title="Permalink to this headline">¶</a></h2>
<p>One of the most exciting feature of a template engine like Twig is the
possibility to define new language constructs. This is also the most complex
feature as you need to understand how Twig's internals work.</p>
<p>Let's create a simple <tt class="docutils literal"><code>set</code></tt> tag that allows the definition of simple
variables from within a template. The tag can be used like follows:</p>
<div class="literal-block"><div class="highlight-jinja"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">{%</span> <span class="k">set</span> <span class="nv">name</span> <span class="o">=</span> <span class="s2">&quot;value&quot;</span> <span class="cp">%}</span><span class="x"></span>

<span class="cp">{{</span> <span class="nv">name</span> <span class="cp">}}</span><span class="x"></span>

<span class="c">{# should output value #}</span><span class="x"></span>
</pre></div>
</td></tr></table></div></div>
<div class="admonition-wrapper">
<div class="note"></div><div class="admonition admonition-note"><p class="first admonition-title">Note</p>
<p class="last">The <tt class="docutils literal"><code>set</code></tt> tag is part of the Core extension and as such is always
available. The built-in version is slightly more powerful and supports
multiple assignments by default (cf. the template designers chapter for
more information).</p>
</div></div>
<p>Three steps are needed to define a new tag:</p>
<ul class="simple">
<li>Defining a Token Parser class (responsible for parsing the template code);</li>
<li>Defining a Node class (responsible for converting the parsed code to PHP);</li>
<li>Registering the tag.</li>
</ul>
<div class="section" id="registering-a-new-tag">
<h3>Registering a new tag<a class="headerlink" href="advanced.html#registering-a-new-tag" title="Permalink to this headline">¶</a></h3>
<p>Adding a tag is as simple as calling the <tt class="docutils literal"><code>addTokenParser</code></tt> method on the
<tt class="docutils literal"><code>Twig_Environment</code></tt> instance:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="nv">$twig</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Twig_Environment</span><span class="p">(</span><span class="nv">$loader</span><span class="p">);</span>
<span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">addTokenParser</span><span class="p">(</span><span class="k">new</span> <span class="nx">Project_Set_TokenParser</span><span class="p">());</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="section" id="defining-a-token-parser">
<h3>Defining a Token Parser<a class="headerlink" href="advanced.html#defining-a-token-parser" title="Permalink to this headline">¶</a></h3>
<p>Now, let's see the actual code of this class:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Project_Set_TokenParser</span> <span class="k">extends</span> <span class="nx">Twig_TokenParser</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">parse</span><span class="p">(</span><span class="nx">Twig_Token</span> <span class="nv">$token</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$lineno</span> <span class="o">=</span> <span class="nv">$token</span><span class="o">-&gt;</span><span class="na">getLine</span><span class="p">();</span>
        <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parser</span><span class="o">-&gt;</span><span class="na">getStream</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">expect</span><span class="p">(</span><span class="nx">Twig_Token</span><span class="o">::</span><span class="na">NAME_TYPE</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getValue</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parser</span><span class="o">-&gt;</span><span class="na">getStream</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">expect</span><span class="p">(</span><span class="nx">Twig_Token</span><span class="o">::</span><span class="na">OPERATOR_TYPE</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">);</span>
        <span class="nv">$value</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parser</span><span class="o">-&gt;</span><span class="na">getExpressionParser</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">parseExpression</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parser</span><span class="o">-&gt;</span><span class="na">getStream</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">expect</span><span class="p">(</span><span class="nx">Twig_Token</span><span class="o">::</span><span class="na">BLOCK_END_TYPE</span><span class="p">);</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nx">Project_Set_Node</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nv">$value</span><span class="p">,</span> <span class="nv">$lineno</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getTag</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getTag</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;set&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>The <tt class="docutils literal"><code>getTag()</code></tt> method must return the tag we want to parse, here <tt class="docutils literal"><code>set</code></tt>.</p>
<p>The <tt class="docutils literal"><code>parse()</code></tt> method is invoked whenever the parser encounters a <tt class="docutils literal"><code>set</code></tt>
tag. It should return a <tt class="docutils literal"><code>Twig_Node</code></tt> instance that represents the node (the
<tt class="docutils literal"><code>Project_Set_Node</code></tt> calls creating is explained in the next section).</p>
<p>The parsing process is simplified thanks to a bunch of methods you can call
from the token stream (<tt class="docutils literal"><code>$this-&gt;parser-&gt;getStream()</code></tt>):</p>
<ul class="simple">
<li><tt class="docutils literal"><code>getCurrent()</code></tt>: Gets the current token in the stream.</li>
<li><tt class="docutils literal"><code>next()</code></tt>: Moves to the next token in the stream, <em>but returns the old one</em>.</li>
<li><tt class="docutils literal"><code>test($type)</code></tt>, <tt class="docutils literal"><code>test($value)</code></tt> or <tt class="docutils literal"><code>test($type, $value)</code></tt>: Determines whether
the current token is of a particular type or value (or both). The value may be an
array of several possible values.</li>
<li><tt class="docutils literal"><code>expect($type[, $value[, $message]])</code></tt>: If the current token isn't of the given
type/value a syntax error is thrown. Otherwise, if the type and value are correct,
the token is returned and the stream moves to the next token.</li>
<li><tt class="docutils literal"><code>look()</code></tt>: Looks a the next token without consuming it.</li>
</ul>
<p>Parsing expressions is done by calling the <tt class="docutils literal"><code>parseExpression()</code></tt> like we did for
the <tt class="docutils literal"><code>set</code></tt> tag.</p>
<div class="admonition-wrapper">
<div class="tip"></div><div class="admonition admonition-tip"><p class="first admonition-title">Tip</p>
<p class="last">Reading the existing <tt class="docutils literal"><code>TokenParser</code></tt> classes is the best way to learn all
the nitty-gritty details of the parsing process.</p>
</div></div>
</div>
<div class="section" id="defining-a-node">
<h3>Defining a Node<a class="headerlink" href="advanced.html#defining-a-node" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><code>Project_Set_Node</code></tt> class itself is rather simple:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Project_Set_Node</span> <span class="k">extends</span> <span class="nx">Twig_Node</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$name</span><span class="p">,</span> <span class="nx">Twig_Node_Expression</span> <span class="nv">$value</span><span class="p">,</span> <span class="nv">$lineno</span><span class="p">,</span> <span class="nv">$tag</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;value&#39;</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$name</span><span class="p">),</span> <span class="nv">$lineno</span><span class="p">,</span> <span class="nv">$tag</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">compile</span><span class="p">(</span><span class="nx">Twig_Compiler</span> <span class="nv">$compiler</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$compiler</span>
            <span class="o">-&gt;</span><span class="na">addDebugInfo</span><span class="p">(</span><span class="nv">$this</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">write</span><span class="p">(</span><span class="s1">&#39;$context[\&#39;&#39;</span><span class="o">.</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getAttribute</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;\&#39;] = &#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">subcompile</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getNode</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">))</span>
            <span class="o">-&gt;</span><span class="na">raw</span><span class="p">(</span><span class="s2">&quot;;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>The compiler implements a fluid interface and provides methods that helps the
developer generate beautiful and readable PHP code:</p>
<ul class="simple">
<li><tt class="docutils literal"><code>subcompile()</code></tt>: Compiles a node.</li>
<li><tt class="docutils literal"><code>raw()</code></tt>: Writes the given string as is.</li>
<li><tt class="docutils literal"><code>write()</code></tt>: Writes the given string by adding indentation at the beginning
of each line.</li>
<li><tt class="docutils literal"><code>string()</code></tt>: Writes a quoted string.</li>
<li><tt class="docutils literal"><code>repr()</code></tt>: Writes a PHP representation of a given value (see
<tt class="docutils literal"><code>Twig_Node_For</code></tt> for a usage example).</li>
<li><tt class="docutils literal"><code>addDebugInfo()</code></tt>: Adds the line of the original template file related to
the current node as a comment.</li>
<li><tt class="docutils literal"><code>indent()</code></tt>: Indents the generated code (see <tt class="docutils literal"><code>Twig_Node_Block</code></tt> for a
usage example).</li>
<li><tt class="docutils literal"><code>outdent()</code></tt>: Outdents the generated code (see <tt class="docutils literal"><code>Twig_Node_Block</code></tt> for a
usage example).</li>
</ul>
</div>
</div>
<div class="section" id="creating-an-extension">
<span id="creating-extensions"></span><h2>Creating an Extension<a class="headerlink" href="advanced.html#creating-an-extension" title="Permalink to this headline">¶</a></h2>
<p>The main motivation for writing an extension is to move often used code into a
reusable class like adding support for internationalization. An extension can
define tags, filters, tests, operators, global variables, functions, and node
visitors.</p>
<p>Creating an extension also makes for a better separation of code that is
executed at compilation time and code needed at runtime. As such, it makes
your code faster.</p>
<p>Most of the time, it is useful to create a single extension for your project,
to host all the specific tags and filters you want to add to Twig.</p>
<div class="admonition-wrapper">
<div class="tip"></div><div class="admonition admonition-tip"><p class="first admonition-title">Tip</p>
<p class="last">When packaging your code into an extension, Twig is smart enough to
recompile your templates whenever you make a change to it (when the
<tt class="docutils literal"><code>auto_reload</code></tt> is enabled).</p>
</div></div>
<div class="admonition-wrapper">
<div class="note"></div><div class="admonition admonition-note"><p class="first admonition-title">Note</p>
<p class="last">Before writing your own extensions, have a look at the Twig official
extension repository: <a class="reference external" href="http://github.com/fabpot/Twig-extensions">http://github.com/fabpot/Twig-extensions</a>.</p>
</div></div>
<p>An extension is a class that implements the following interface:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">interface</span> <span class="nx">Twig_ExtensionInterface</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * Initializes the runtime environment.</span>
<span class="sd">     *</span>
<span class="sd">     * This is where you can load some file that contains filter functions for instance.</span>
<span class="sd">     *</span>
<span class="sd">     * @param Twig_Environment $environment The current Twig_Environment instance</span>
<span class="sd">     */</span>
    <span class="k">function</span> <span class="nf">initRuntime</span><span class="p">(</span><span class="nx">Twig_Environment</span> <span class="nv">$environment</span><span class="p">);</span>

    <span class="sd">/**</span>
<span class="sd">     * Returns the token parser instances to add to the existing list.</span>
<span class="sd">     *</span>
<span class="sd">     * @return array An array of Twig_TokenParserInterface or Twig_TokenParserBrokerInterface instances</span>
<span class="sd">     */</span>
    <span class="k">function</span> <span class="nf">getTokenParsers</span><span class="p">();</span>

    <span class="sd">/**</span>
<span class="sd">     * Returns the node visitor instances to add to the existing list.</span>
<span class="sd">     *</span>
<span class="sd">     * @return array An array of Twig_NodeVisitorInterface instances</span>
<span class="sd">     */</span>
    <span class="k">function</span> <span class="nf">getNodeVisitors</span><span class="p">();</span>

    <span class="sd">/**</span>
<span class="sd">     * Returns a list of filters to add to the existing list.</span>
<span class="sd">     *</span>
<span class="sd">     * @return array An array of filters</span>
<span class="sd">     */</span>
    <span class="k">function</span> <span class="nf">getFilters</span><span class="p">();</span>

    <span class="sd">/**</span>
<span class="sd">     * Returns a list of tests to add to the existing list.</span>
<span class="sd">     *</span>
<span class="sd">     * @return array An array of tests</span>
<span class="sd">     */</span>
    <span class="k">function</span> <span class="nf">getTests</span><span class="p">();</span>

    <span class="sd">/**</span>
<span class="sd">     * Returns a list of functions to add to the existing list.</span>
<span class="sd">     *</span>
<span class="sd">     * @return array An array of functions</span>
<span class="sd">     */</span>
    <span class="k">function</span> <span class="nf">getFunctions</span><span class="p">();</span>

    <span class="sd">/**</span>
<span class="sd">     * Returns a list of operators to add to the existing list.</span>
<span class="sd">     *</span>
<span class="sd">     * @return array An array of operators</span>
<span class="sd">     */</span>
    <span class="k">function</span> <span class="nf">getOperators</span><span class="p">();</span>

    <span class="sd">/**</span>
<span class="sd">     * Returns a list of global variables to add to the existing list.</span>
<span class="sd">     *</span>
<span class="sd">     * @return array An array of global variables</span>
<span class="sd">     */</span>
    <span class="k">function</span> <span class="nf">getGlobals</span><span class="p">();</span>

    <span class="sd">/**</span>
<span class="sd">     * Returns the name of the extension.</span>
<span class="sd">     *</span>
<span class="sd">     * @return string The extension name</span>
<span class="sd">     */</span>
    <span class="k">function</span> <span class="nf">getName</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>To keep your extension class clean and lean, it can inherit from the built-in
<tt class="docutils literal"><code>Twig_Extension</code></tt> class instead of implementing the whole interface. That
way, you just need to implement the <tt class="docutils literal"><code>getName()</code></tt> method as the
<tt class="docutils literal"><code>Twig_Extension</code></tt> provides empty implementations for all other methods.</p>
<p>The <tt class="docutils literal"><code>getName()</code></tt> method must return a unique identifier for your extension.</p>
<p>Now, with this information in mind, let's create the most basic extension
possible:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Project_Twig_Extension</span> <span class="k">extends</span> <span class="nx">Twig_Extension</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getName</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;project&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<div class="admonition-wrapper">
<div class="note"></div><div class="admonition admonition-note"><p class="first admonition-title">Note</p>
<p class="last">Of course, this extension does nothing for now. We will customize it in
the next sections.</p>
</div></div>
<p>Twig does not care where you save your extension on the filesystem, as all
extensions must be registered explicitly to be available in your templates.</p>
<p>You can register an extension by using the <tt class="docutils literal"><code>addExtension()</code></tt> method on your
main <tt class="docutils literal"><code>Environment</code></tt> object:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="nv">$twig</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Twig_Environment</span><span class="p">(</span><span class="nv">$loader</span><span class="p">);</span>
<span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">addExtension</span><span class="p">(</span><span class="k">new</span> <span class="nx">Project_Twig_Extension</span><span class="p">());</span>
</pre></div>
</td></tr></table></div></div>
<p>Of course, you need to first load the extension file by either using
<tt class="docutils literal"><code>require_once()</code></tt> or by using an autoloader (see <a class="reference external" href="http://www.php.net/spl_autoload_register">spl_autoload_register()</a>).</p>
<div class="admonition-wrapper">
<div class="tip"></div><div class="admonition admonition-tip"><p class="first admonition-title">Tip</p>
<p class="last">The bundled extensions are great examples of how extensions work.</p>
</div></div>
<div class="section" id="id1">
<h3>Globals<a class="headerlink" href="advanced.html#id1" title="Permalink to this headline">¶</a></h3>
<p>Global variables can be registered in an extension via the <tt class="docutils literal"><code>getGlobals()</code></tt>
method:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Project_Twig_Extension</span> <span class="k">extends</span> <span class="nx">Twig_Extension</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getGlobals</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;text&#39;</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">Text</span><span class="p">(),</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="section" id="id2">
<h3>Functions<a class="headerlink" href="advanced.html#id2" title="Permalink to this headline">¶</a></h3>
<p>Functions can be registered in an extension via the <tt class="docutils literal"><code>getFunctions()</code></tt>
method:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Project_Twig_Extension</span> <span class="k">extends</span> <span class="nx">Twig_Extension</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getFunctions</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;lipsum&#39;</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">Twig_Function_Function</span><span class="p">(</span><span class="s1">&#39;generate_lipsum&#39;</span><span class="p">),</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="section" id="id3">
<h3>Filters<a class="headerlink" href="advanced.html#id3" title="Permalink to this headline">¶</a></h3>
<p>To add a filter to an extension, you need to override the <tt class="docutils literal"><code>getFilters()</code></tt>
method. This method must return an array of filters to add to the Twig
environment:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Project_Twig_Extension</span> <span class="k">extends</span> <span class="nx">Twig_Extension</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getFilters</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;rot13&#39;</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">Twig_Filter_Function</span><span class="p">(</span><span class="s1">&#39;str_rot13&#39;</span><span class="p">),</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>As you can see in the above code, the <tt class="docutils literal"><code>getFilters()</code></tt> method returns an array
where keys are the name of the filters (<tt class="docutils literal"><code>rot13</code></tt>) and the values the
definition of the filter (<tt class="docutils literal"><code>new Twig_Filter_Function('str_rot13')</code></tt>).</p>
<p>As seen in the previous chapter, you can also define filters as static methods
on the extension class:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">addFilter</span><span class="p">(</span><span class="s1">&#39;rot13&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Twig_Filter_Function</span><span class="p">(</span><span class="s1">&#39;Project_Twig_Extension::rot13Filter&#39;</span><span class="p">));</span>
</pre></div>
</td></tr></table></div></div>
<p>You can also use <tt class="docutils literal"><code>Twig_Filter_Method</code></tt> instead of <tt class="docutils literal"><code>Twig_Filter_Function</code></tt>
when defining a filter to use a method:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Project_Twig_Extension</span> <span class="k">extends</span> <span class="nx">Twig_Extension</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getFilters</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;rot13&#39;</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">Twig_Filter_Method</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;rot13Filter&#39;</span><span class="p">),</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">rot13Filter</span><span class="p">(</span><span class="nv">$string</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">str_rot13</span><span class="p">(</span><span class="nv">$string</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>The first argument of the <tt class="docutils literal"><code>Twig_Filter_Method</code></tt> constructor is always
<tt class="docutils literal"><code>$this</code></tt>, the current extension object. The second one is the name of the
method to call.</p>
<p>Using methods for filters is a great way to package your filter without
polluting the global namespace. This also gives the developer more flexibility
at the cost of a small overhead.</p>
<div class="section" id="overriding-default-filters">
<h4>Overriding default Filters<a class="headerlink" href="advanced.html#overriding-default-filters" title="Permalink to this headline">¶</a></h4>
<p>If some default core filters do not suit your needs, you can easily override
them by creating your own core extension. Of course, you don't need to copy
and paste the whole core extension code of Twig. Instead, you can just extends
it and override the filter(s) you want by overriding the <tt class="docutils literal"><code>getFilters()</code></tt>
method:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MyCoreExtension</span> <span class="k">extends</span> <span class="nx">Twig_Extension_Core</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getFilters</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">array_merge</span><span class="p">(</span><span class="k">parent</span><span class="o">::</span><span class="na">getFilters</span><span class="p">(),</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;date&#39;</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">Twig_Filter_Method</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;dateFilter&#39;</span><span class="p">),</span>
            <span class="c1">// ...</span>
        <span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">dateFilter</span><span class="p">(</span><span class="nv">$timestamp</span><span class="p">,</span> <span class="nv">$format</span> <span class="o">=</span> <span class="s1">&#39;F j, Y H:i&#39;</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s1">&#39;...&#39;</span><span class="o">.</span><span class="nx">twig_date_format_filter</span><span class="p">(</span><span class="nv">$timestamp</span><span class="p">,</span> <span class="nv">$format</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Here, we override the <tt class="docutils literal"><code>date</code></tt> filter with a custom one. Using this new core
extension is as simple as registering the <tt class="docutils literal"><code>MyCoreExtension</code></tt> extension by
calling the <tt class="docutils literal"><code>addExtension()</code></tt> method on the environment instance:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="nv">$twig</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Twig_Environment</span><span class="p">(</span><span class="nv">$loader</span><span class="p">);</span>
<span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">addExtension</span><span class="p">(</span><span class="k">new</span> <span class="nx">MyCoreExtension</span><span class="p">());</span>
</pre></div>
</td></tr></table></div></div>
<p>But I can already hear some people wondering how it can work as the Core
extension is loaded by default. That's true, but the trick is that both
extensions share the same unique identifier (<tt class="docutils literal"><code>core</code></tt> - defined in the
<tt class="docutils literal"><code>getName()</code></tt> method). By registering an extension with the same name as an
existing one, you have actually overridden the default one, even if it is
already registered:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">addExtension</span><span class="p">(</span><span class="k">new</span> <span class="nx">Twig_Extension_Core</span><span class="p">());</span>
<span class="nv">$twig</span><span class="o">-&gt;</span><span class="na">addExtension</span><span class="p">(</span><span class="k">new</span> <span class="nx">MyCoreExtension</span><span class="p">());</span>
</pre></div>
</td></tr></table></div></div>
</div>
</div>
<div class="section" id="id4">
<h3>Tags<a class="headerlink" href="advanced.html#id4" title="Permalink to this headline">¶</a></h3>
<p>Adding a tag in an extension can be done by overriding the
<tt class="docutils literal"><code>getTokenParsers()</code></tt> method. This method must return an array of tags to add
to the Twig environment:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Project_Twig_Extension</span> <span class="k">extends</span> <span class="nx">Twig_Extension</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getTokenParsers</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="k">new</span> <span class="nx">Project_Set_TokenParser</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>In the above code, we have added a single new tag, defined by the
<tt class="docutils literal"><code>Project_Set_TokenParser</code></tt> class. The <tt class="docutils literal"><code>Project_Set_TokenParser</code></tt> class is
responsible for parsing the tag and compiling it to PHP.</p>
</div>
<div class="section" id="operators">
<h3>Operators<a class="headerlink" href="advanced.html#operators" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><code>getOperators()</code></tt> methods allows to add new operators. Here is how to add
<tt class="docutils literal"><code>!</code></tt>, <tt class="docutils literal"><code>||</code></tt>, and <tt class="docutils literal"><code>&amp;&amp;</code></tt> operators:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Project_Twig_Extension</span> <span class="k">extends</span> <span class="nx">Twig_Extension</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getOperators</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
            <span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;!&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;precedence&#39;</span> <span class="o">=&gt;</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Twig_Node_Expression_Unary_Not&#39;</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="k">array</span><span class="p">(</span>
                <span class="s1">&#39;||&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;precedence&#39;</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Twig_Node_Expression_Binary_Or&#39;</span><span class="p">,</span> <span class="s1">&#39;associativity&#39;</span> <span class="o">=&gt;</span> <span class="nx">Twig_ExpressionParser</span><span class="o">::</span><span class="na">OPERATOR_LEFT</span><span class="p">),</span>
                <span class="s1">&#39;&amp;&amp;&#39;</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;precedence&#39;</span> <span class="o">=&gt;</span> <span class="mi">15</span><span class="p">,</span> <span class="s1">&#39;class&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Twig_Node_Expression_Binary_And&#39;</span><span class="p">,</span> <span class="s1">&#39;associativity&#39;</span> <span class="o">=&gt;</span> <span class="nx">Twig_ExpressionParser</span><span class="o">::</span><span class="na">OPERATOR_LEFT</span><span class="p">),</span>
            <span class="p">),</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
</div>
<div class="section" id="tests">
<h3>Tests<a class="headerlink" href="advanced.html#tests" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><code>getTests()</code></tt> methods allows to add new test functions:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Project_Twig_Extension</span> <span class="k">extends</span> <span class="nx">Twig_Extension</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getTests</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">&#39;even&#39;</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nx">Twig_Test_Function</span><span class="p">(</span><span class="s1">&#39;twig_test_even&#39;</span><span class="p">),</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
</div>
</div>
<div class="section" id="testing-an-extension">
<h2>Testing an Extension<a class="headerlink" href="advanced.html#testing-an-extension" title="Permalink to this headline">¶</a></h2>
<p class="versionadded">
<span class="versionmodified">New in version 1.10: </span>Support for functional tests was added in Twig 1.10.</p>
<div class="section" id="functional-tests">
<h3>Functional Tests<a class="headerlink" href="advanced.html#functional-tests" title="Permalink to this headline">¶</a></h3>
<p>You can create functional tests for extensions simply by creating the
following file structure in your test directory:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span class="nx">Fixtures</span><span class="o">/</span>
    <span class="nx">filters</span><span class="o">/</span>
        <span class="nx">foo</span><span class="o">.</span><span class="nx">test</span>
        <span class="nx">bar</span><span class="o">.</span><span class="nx">test</span>
    <span class="nx">functions</span><span class="o">/</span>
        <span class="nx">foo</span><span class="o">.</span><span class="nx">test</span>
        <span class="nx">bar</span><span class="o">.</span><span class="nx">test</span>
    <span class="nx">tags</span><span class="o">/</span>
        <span class="nx">foo</span><span class="o">.</span><span class="nx">test</span>
        <span class="nx">bar</span><span class="o">.</span><span class="nx">test</span>
<span class="nx">IntegrationTest</span><span class="o">.</span><span class="nx">php</span>
</pre></div>
</td></tr></table></div></div>
<p>The <tt class="docutils literal"><code>IntegrationTest.php</code></tt> file should look like this:</p>
<div class="literal-block"><div class="highlight-php"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Project_Tests_IntegrationTest</span> <span class="k">extends</span> <span class="nx">Twig_Test_IntegrationTestCase</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getExtensions</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
            <span class="k">new</span> <span class="nx">Project_Twig_Extension1</span><span class="p">(),</span>
            <span class="k">new</span> <span class="nx">Project_Twig_Extension2</span><span class="p">(),</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getFixturesDir</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;/Fixtures/&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div></div>
<p>Fixtures examples can be found within the Twig repository
<a class="reference external" href="https://github.com/fabpot/Twig/tree/master/test/Twig/Tests/Fixtures">tests/Twig/Fixtures</a> directory.</p>
</div>
<div class="section" id="node-tests">
<h3>Node Tests<a class="headerlink" href="advanced.html#node-tests" title="Permalink to this headline">¶</a></h3>
<p>Testing the node visitors can be complex, so extend your test cases from
<tt class="docutils literal"><code>Twig_Test_NodeTestCase</code></tt>. Examples can be found in the Twig repository
<a class="reference external" href="https://github.com/fabpot/Twig/tree/master/test/Twig/Tests/Node">tests/Twig/Node</a> directory.</p>
</div>
</div>
</div>

    </div>

            <div class="navigation">
                            <a accesskey="P" title="Twig for Developers" href="api.html">
                    &laquo;&nbsp;Twig for Developers
                </a>
                        <span class="separator">|</span>                            <a accesskey="N" title="Twig Internals" href="internals.html">
                    Twig Internals&nbsp;&raquo;
                </a>
                    </div>
          </div>
      <div class="ft">
        <div class="content">
          This website is powered by PHP and Twig. The Twig <a href="../images/twig-logo.png">logo</a> is &copy; 2010-2012 Sensio Labs
        </div>
      </div>
    </div>
  </body>
</html>
